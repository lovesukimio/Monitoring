name: ğŸ”„ åŒæ­¥ä¸Šæ¸¸ (Sync Upstream)

on:
  schedule:
    - cron: '15 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºæ‚¨çš„åˆ†æ”¯
      - name: 1. æ£€å‡ºæ‚¨çš„åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0 

      # æ­¥éª¤ 2: å¤‡ä»½è‡ªå®šä¹‰å·¥ä½œæµ
      # ã€!ä¿®å¤!ã€‘ å¿…é¡»å¤‡ä»½åˆ°å·¥ä½œç›®å½•ä¹‹å¤– (~)
      - name: 2. å¤‡ä»½è‡ªå®šä¹‰å·¥ä½œæµ
        run: |
          echo "Backing up sync.yml to ~/tmp_workflow_backup"
          mkdir -p ~/tmp_workflow_backup
          cp ./.github/workflows/sync.yml ~/tmp_workflow_backup/

      # æ­¥éª¤ 3: é…ç½® Git ç”¨æˆ·
      - name: 3. é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # æ­¥éª¤ 4: æ·»åŠ å¹¶æ‹‰å–ä¸Šæ¸¸
      - name: 4. æ·»åŠ å¹¶æ‹‰å–ä¸Šæ¸¸
        run: |
          git remote add upstream https://github.com/louislam/uptime-kuma.git
          git fetch upstream master

      # æ­¥éª¤ 5: ç¡¬é‡ç½®åˆ°ä¸Šæ¸¸çš„ master åˆ†æ”¯
      - name: 5. ç¡¬é‡ç½®åˆ°ä¸Šæ¸¸ master
        run: git reset --hard upstream/master

      # æ­¥éª¤ 6: æ¢å¤è‡ªå®šä¹‰å·¥ä½œæµ
      # ã€!ä¿®å¤!ã€‘ ä»å·¥ä½œç›®å½•ä¹‹å¤– (~) æ¢å¤
      - name: 6. æ¢å¤è‡ªå®šä¹‰å·¥ä½œæµ
        run: |
          echo "Restoring sync.yml from ~/tmp_workflow_backup"
          mkdir -p ./.github/workflows
          cp ~/tmp_workflow_backup/sync.yml ./.github/workflows/sync.yml
          rm -rf ~/tmp_workflow_backup

      # æ­¥éª¤ 7: æäº¤è¿™ä¸ªå”¯ä¸€çš„æ›´æ”¹
      - name: 7. æäº¤è‡ªå®šä¹‰å·¥ä½œæµ
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„è¢«æ·»åŠ å›æ¥äº†
          if [ -f ".github/workflows/sync.yml" ]; then
            echo "sync.yml restored. Committing changes."
            git add ./.github/workflows/sync.yml
            # åªæœ‰åœ¨æš‚å­˜åŒºæœ‰æ–‡ä»¶æ—¶æ‰æäº¤
            git diff-index --quiet HEAD || git commit -m "CI: è‡ªåŠ¨åŒæ­¥ - é‡æ–°æ·»åŠ è‡ªå®šä¹‰çš„ sync.yml"
          else
            echo "Error: sync.yml was not restored!"
            exit 1
          fi

      # æ­¥éª¤ 8: å¼ºè¡Œæ¨é€åˆ°æ‚¨çš„ä»“åº“
      - name: 8. å¼ºè¡Œæ¨é€è‡³æ‚¨çš„ä»“åº“
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:master --force
